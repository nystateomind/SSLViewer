<!DOCTYPE html>
<html lang="en" class="">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSL/TLS Certificate Tools</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <link href="./output.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        textarea,
        pre,
        code {
            font-family: 'JetBrains Mono', monospace;
        }

        .form-input:focus {
            outline: none;
            border-color: #6366f1;
            /* Indigo 500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        /* Dark mode focus overrides */
        .dark .form-input:focus {
            border-color: #818cf8;
            /* Indigo 400 */
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2);
        }

        .result-box {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .tab-content,
        .hidden {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modern Tab Styles */
        nav a {
            position: relative;
            transition: all 0.2s ease;
        }

        nav a::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: transparent;
            transition: background-color 0.2s ease;
        }

        nav a.active {
            color: #4f46e5;
        }

        .dark nav a.active {
            color: #818cf8;
        }

        nav a.active::after {
            background-color: #4f46e5;
        }

        .dark nav a.active::after {
            background-color: #818cf8;
        }

        /* Number input cleanup */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            appearance: textfield;
        }
    </style>
</head>

<body
    class="antialiased text-slate-800 bg-slate-50 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-200">

    <div class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="flex justify-between items-start mb-10">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight"><a href="./">SSL/TLS
                        Tools</a></h1>
                <p class="mt-2 text-slate-500 dark:text-slate-400">Diagnostic utilities for certificates & encryption
                </p>
            </div>

            <button id="theme-toggle"
                class="p-2 rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500"
                aria-label="Toggle Dark Mode">
                <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"
                        fill-rule="evenodd" clip-rule="evenodd"></path>
                </svg>
                <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                </svg>
            </button>
        </header>

        <div class="mb-8 border-b border-slate-200 dark:border-slate-700">
            <nav class="flex flex-wrap -mb-px space-x-8" aria-label="Tabs">
                <a href="#cert_chain" onclick="switchTab('cert_chain', event)"
                    class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    Chain Viewer
                </a>
                <a href="#decoder" onclick="switchTab('decoder', event)"
                    class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    PEM Decoder
                </a>
                <a href="#decryption" onclick="switchTab('decryption', event)"
                    class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Key Decrypter
                </a>
            </nav>
        </div>

        <main>
            <div id="tab-cert_chain" class="tab-content active">
                <div
                    class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 transition-colors">
                    <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-2">Remote Chain Verification</h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">Validate the installation of a server's
                        certificate chain.</p>

                    <form id="verify-form" class="flex flex-col sm:flex-row items-center gap-3">
                        <input id="hostname-input" type="text" value="" placeholder="Hostname (ex. google.com)"
                            class="w-full sm:flex-1 p-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm form-input transition text-sm text-slate-900 dark:text-white placeholder:text-slate-400"
                            required>
                        <input id="port-input" type="number" value="443" placeholder="Port"
                            class="w-full sm:w-24 p-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm form-input transition text-sm text-slate-900 dark:text-white"
                            required ondblclick="this.select()">
                        <button id="submit-button" type="submit"
                            class="w-full sm:w-auto flex-grow sm:flex-grow-0 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-600 dark:hover:bg-indigo-500 disabled:bg-slate-400 disabled:cursor-not-allowed text-white font-semibold py-2.5 px-6 rounded-lg flex items-center justify-center transition-all duration-200 shadow-sm text-sm">
                            <span id="button-text">Connect</span>
                            <span id="button-loader" class="hidden flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                Verifying...
                            </span>
                        </button>
                    </form>
                    <div class="mt-4">
                        <label class="inline-flex items-center cursor-pointer group">
                            <input type="checkbox" id="enhanced-scan-checkbox"
                                class="form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-indigo-500 transition-colors">
                            <span
                                class="ml-2 text-sm text-slate-600 dark:text-slate-400 group-hover:text-slate-800 dark:group-hover:text-slate-300 transition-colors">Run
                                enhanced vulnerability scan</span>
                        </label>
                    </div>
                    <div id="results-container" class="mt-8 space-y-4"></div>
                    <div id="sslyze-results-container" class="mt-8"></div>
                </div>
            </div>

            <div id="tab-decoder" class="tab-content">
                <div
                    class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 transition-colors">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-semibold text-slate-900 dark:text-white">PEM Decoder</h2>
                        <span
                            class="inline-flex items-center rounded-md bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 text-xs font-medium text-emerald-700 dark:text-emerald-400 ring-1 ring-inset ring-emerald-600/20">
                            <svg class="mr-1.5 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
                            </svg>
                            Processed Locally
                        </span>
                    </div>
                    <p class="text-slate-500 dark:text-slate-400 mb-4 text-sm">Paste a PEM-formatted certificate (CRT)
                        or request (CSR).</p>

                    <div class="relative group">
                        <textarea id="certInput"
                            class="w-full h-64 p-4 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm form-input transition text-xs text-slate-800 dark:text-slate-200 placeholder:text-slate-400"
                            placeholder="-----BEGIN CERTIFICATE-----&#10;...&#10;-----END CERTIFICATE-----"></textarea>

                        <button
                            onclick="document.getElementById('certInput').value = ''; document.getElementById('certInput').focus();"
                            class="absolute top-2 right-2 p-1.5 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 bg-transparent rounded-md transition-colors"
                            title="Clear">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button onclick="decodeCert()"
                            class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-600 dark:hover:bg-indigo-500 text-white font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:ring-offset-slate-900 transition text-sm">
                            Decode Certificate
                        </button>
                    </div>
                    <div id="decoderOutput" class="mt-6"></div>
                </div>
            </div>

            <div id="tab-decryption" class="tab-content">
                <div
                    class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 transition-colors">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Private Key Decryption</h2>
                        <span
                            class="inline-flex items-center rounded-md bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 text-xs font-medium text-emerald-700 dark:text-emerald-400 ring-1 ring-inset ring-emerald-600/20">
                            <svg class="mr-1.5 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
                            </svg>
                            Processed Locally
                        </span>
                    </div>

                    <div class="mb-6 rounded-lg overflow-hidden border border-slate-300 dark:border-slate-600">
                        <div
                            class="bg-slate-100 dark:bg-slate-900 px-4 py-2 border-b border-slate-300 dark:border-slate-600">
                            <span class="text-xs font-mono text-slate-500">Local Terminal Alternatives</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-black p-4 font-mono text-xs text-slate-700 dark:text-slate-300">
                            <div class="mb-2">
                                <span class="text-indigo-500 select-none">$</span> openssl rsa -in encrypted.key -out
                                unencrypted.key
                            </div>
                            <div>
                                <span class="text-indigo-500 select-none">$</span> ssh-keygen -p -m PEM -N "" -f
                                hostname.key
                            </div>
                        </div>
                    </div>

                    <p class="text-slate-500 dark:text-slate-400 mb-4 text-sm">Or paste your encrypted PEM private key
                        below:</p>

                    <div class="space-y-4">
                        <div class="relative group">
                            <textarea id="pemText"
                                class="w-full h-48 p-4 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm form-input transition text-xs text-slate-800 dark:text-slate-200 placeholder:text-slate-400"
                                placeholder="-----BEGIN ENCRYPTED PRIVATE KEY-----&#10;...&#10;-----END ENCRYPTED PRIVATE KEY-----"></textarea>
                            <button
                                onclick="document.getElementById('pemText').value = ''; document.getElementById('pemText').focus();"
                                class="absolute top-2 right-2 p-1.5 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 bg-transparent rounded-md transition-colors"
                                title="Clear">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>

                        <div class="flex flex-col sm:flex-row sm:items-end sm:space-x-4">
                            <div class="flex-grow">
                                <label for="passphrase"
                                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Key
                                    Password</label>
                                <input type="password" id="passphrase"
                                    class="w-full p-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm form-input transition text-sm text-slate-900 dark:text-white"
                                    placeholder="••••••••••">
                            </div>
                            <button id="remove-password-button" onclick="removePassword()"
                                class="mt-4 sm:mt-0 px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-600 dark:hover:bg-indigo-500 text-white font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:ring-offset-slate-900 transition whitespace-nowrap text-sm">
                                Decrypt Key
                            </button>
                        </div>
                    </div>
                    <div id="decryptedOutputSection" class="hidden">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white mt-8 mb-3">Decrypted Key Output
                        </h3>
                        <pre id="removerOutput"
                            class="p-4 bg-slate-50 dark:bg-black border border-slate-200 dark:border-slate-700 rounded-lg result-box font-mono text-xs text-slate-800 dark:text-emerald-400 overflow-x-auto"></pre>
                        <div id="removerDownloadContainer" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <template id="loading-template">
        <div class="text-center p-12">
            <div role="status" class="flex justify-center items-center flex-col">
                <svg class="animate-spin h-10 w-10 text-indigo-600 dark:text-indigo-500 mb-4"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <span class="text-lg font-medium text-slate-600 dark:text-slate-300">Connecting and analyzing
                    certificate chain...</span>
            </div>
        </div>
    </template>

    <template id="error-template">
        <div
            class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300 p-4 rounded-lg flex items-start">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="h-5 w-5 mr-3 flex-shrink-0 mt-0.5">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <div>
                <h4 class="font-bold text-sm">Verification Failed</h4>
                <p class="error-message text-sm mt-1 opacity-90"></p>
            </div>
        </div>
    </template>

    <template id="warning-template">
        <div
            class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-amber-800 dark:text-amber-300 p-4 rounded-lg flex items-start mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="h-5 w-5 mr-3 flex-shrink-0 mt-0.5">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <div>
                <h4 class="font-bold text-sm">Missing Intermediate Certificate</h4>
                <p class="text-sm mt-1 opacity-90">The server is not sending an intermediate certificate. While some
                    browsers can fetch it, this can cause issues with other clients.</p>
            </div>
        </div>
    </template>

    <template id="certificate-card-template">
        <div
            class="cert-card bg-slate-50 dark:bg-slate-850/50 rounded-lg shadow-sm border transition-all duration-300 mb-6 overflow-hidden">
            <div class="px-5 py-4 cert-header-container bg-slate-100/50 dark:bg-slate-800/50">
            </div>
            <div class="border-t border-slate-200 dark:border-slate-700 px-5 py-4">
                <dl class="divide-y divide-slate-200 dark:divide-slate-700/50">
                </dl>
            </div>
        </div>
    </template>

    <template id="chain-status-success-template">
        <div
            class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 text-emerald-800 dark:text-emerald-300 p-4 rounded-lg flex items-start mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="h-5 w-5 mr-3 flex-shrink-0 mt-0.5">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <div>
                <h4 class="font-bold text-sm">Certificate Chain Valid</h4>
                <p class="chain-status-message text-sm mt-1 opacity-90"></p>
            </div>
        </div>
    </template>

    <template id="chain-status-warning-template">
        <div
            class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-amber-800 dark:text-amber-300 p-4 rounded-lg flex items-start mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="h-5 w-5 mr-3 flex-shrink-0 mt-0.5">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <div>
                <h4 class="font-bold text-sm">Certificate Issues Detected</h4>
                <p class="chain-status-message text-sm mt-1 opacity-90"></p>
                <ul class="chain-status-issues mt-2 text-sm list-disc list-inside opacity-90"></ul>
            </div>
        </div>
    </template>

    <template id="chain-status-critical-template">
        <div
            class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300 p-4 rounded-lg flex items-start mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="h-5 w-5 mr-3 flex-shrink-0 mt-0.5">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <div>
                <h4 class="font-bold text-sm">Critical Certificate Issue</h4>
                <p class="chain-status-message text-sm mt-1 opacity-90"></p>
                <ul class="chain-status-issues mt-2 text-sm list-disc list-inside opacity-90"></ul>
            </div>
        </div>
    </template>

    <template id="sslyze-loading-template">
        <div
            class="text-center p-8 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700">
            <div role="status" class="flex justify-center items-center flex-col">
                <svg class="animate-spin h-8 w-8 text-indigo-600 dark:text-indigo-400 mb-3"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <span class="text-md font-medium text-slate-700 dark:text-slate-300">Running vulnerability
                    scan...</span>
                <span class="text-xs text-slate-500 dark:text-slate-400 mt-1">This may take up to 2 minutes</span>
            </div>
        </div>
    </template>

    <template id="sslyze-results-template">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="mr-2 text-indigo-600 dark:text-indigo-400">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    <path d="m9 12 2 2 4-4"></path>
                </svg>
                Enhanced Vulnerability Scan Results
            </h3>
            <div class="sslyze-content"></div>
        </div>
    </template>

    <script>
        // ============================================================================
        // GLOBAL HELPER FUNCTIONS
        // ============================================================================

        /**
         * Creates a styled section block for certificate/CSR output display.
         * @param {string} title - Section header text
         * @param {string} content - HTML content for the section body
         * @returns {string} HTML string for the section, or empty string if no content
         */
        function createSection(title, content) {
            if (!content || content.trim() === '') return '';
            return `<div class="border-b border-slate-200 dark:border-slate-700 last:border-0">
                <div class="px-4 py-2 bg-slate-100/50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-800">
                    <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">${title}</h4>
                </div>
                <div class="p-4 space-y-1 text-sm text-slate-800 dark:text-slate-300">${content}</div>
            </div>`;
        }

        /**
         * Returns sort priority for DN attribute short names (CN first, C last).
         * @param {string} shortName - Attribute short name (CN, O, OU, etc.)
         * @returns {number} Sort priority (lower = higher priority)
         */
        function getSortOrder(shortName) {
            const order = { 'CN': 1, 'OU': 2, 'O': 3, 'L': 4, 'ST': 5, 'C': 99 };
            return order[shortName] || 50;
        }

        /**
         * Sorts DN attributes by conventional order (CN first, country last).
         * @param {Array} attributes - Array of attribute objects with shortName property
         * @returns {Array} Sorted copy of the attributes array
         */
        function sortAttributes(attributes) {
            return [...attributes].sort((a, b) => getSortOrder(a.shortName) - getSortOrder(b.shortName));
        }

        /**
         * Activates a specific tab by name, updating both content and nav styling.
         * @param {string} tabName - Tab identifier (cert_chain, decoder, decryption)
         */
        function activateTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            const targetButton = document.querySelector(`a[href="#${tabName}"]`);
            if (targetButton) targetButton.classList.add('active');
        }

        // ============================================================================
        // DARK MODE LOGIC
        // ============================================================================
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        // Check local storage or system preference
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            themeToggleDarkIcon.classList.remove('hidden');
        }

        themeToggleBtn.addEventListener('click', function () {
            // Toggle icons
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');

            // Toggle dark class and persist preference
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
        });

        // ============================================================================
        // TAB SWITCHING LOGIC WITH URL HASH ROUTING
        // ============================================================================

        /**
         * Switches to a tab and updates the URL hash.
         * @param {string} tabName - Tab identifier
         * @param {Event} event - Click event (optional)
         */
        function switchTab(tabName, event) {
            if (event) event.preventDefault();

            // Update URL hash - don't add hash for default tab (cert_chain)
            const newUrl = tabName === 'cert_chain'
                ? (window.location.search || window.location.pathname)
                : window.location.pathname + '#' + tabName;
            history.replaceState(null, '', newUrl);

            activateTab(tabName);
        }

        /**
         * Handles URL hash changes and activates the corresponding tab.
         */
        function handleHashChange() {
            let hash = window.location.hash.replace('#', '');
            const validTabs = ['cert_chain', 'decoder', 'decryption'];

            // Default to cert_chain if hostname param present
            if (!hash && window.location.search) {
                const params = new URLSearchParams(window.location.search);
                if (params.get('hostname')) hash = 'cert_chain';
            }

            if (hash && validTabs.includes(hash)) {
                activateTab(hash);
            }
        }

        /**
         * Toggles visibility of cipher list in SSLyze results.
         * @param {string} id - Element ID to toggle
         */
        function toggleCipherList(id) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('hidden');
        }

        /**
         * Toggles visibility of DNS records section.
         * @param {string} id - Element ID to toggle
         * @param {HTMLElement} btn - Button element to update text
         */
        function toggleDnsRecords(id, btn) {
            const el = document.getElementById(id);
            if (el) {
                const isHidden = el.classList.toggle('hidden');
                const span = btn.querySelector('span');
                const svg = btn.querySelector('svg');
                if (span) span.textContent = isHidden ? 'Show DNS' : 'Hide DNS';
                if (svg) svg.style.transform = isHidden ? '' : 'rotate(180deg)';
            }
        }

        window.addEventListener('hashchange', handleHashChange);
        document.addEventListener('DOMContentLoaded', function () {
            handleHashChange();
        });

        // ============================================================================
        // CERTIFICATE CHAIN VERIFIER (Tab 1)
        // ============================================================================

        /**
         * Sets up the certificate chain verification form and handlers.
         * Handles remote SSL/TLS connection, certificate parsing, and SSLyze scans.
         */
        function setupCertificateChainVerifier() {
            const form = document.getElementById('verify-form');
            if (!form) return;

            const hostnameInput = document.getElementById('hostname-input');
            const portInput = document.getElementById('port-input');
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const buttonLoader = document.getElementById('button-loader');
            const resultsContainer = document.getElementById('results-container');
            const sslyzeResultsContainer = document.getElementById('sslyze-results-container');
            const enhancedScanCheckbox = document.getElementById('enhanced-scan-checkbox');

            const handleVerify = async (e) => {
                if (e) e.preventDefault();
                resultsContainer.innerHTML = '';
                sslyzeResultsContainer.innerHTML = '';

                let hostname = hostnameInput.value.trim();

                // Validate empty hostname
                if (!hostname) {
                    renderError('Please enter a hostname.');
                    return;
                }

                // Check for wildcard hostname before sanitizing (e.g., *.domain.tld)
                if (/^\s*\*\./.test(hostname)) {
                    renderError('To validate a wildcard certificate, enter a hostname the certificate is installed on.');
                    return;
                }

                setLoading(true);

                hostname = hostname.replace(/^[^a-zA-Z0-9]+/, '').replace(/^.*\/\//, '').replace(/[\/?#].*$/, '').replace(/:\d+$/, '').trim();
                hostnameInput.value = hostname;

                let port = portInput.value.trim();
                portInput.value = port;

                const runEnhancedScan = enhancedScanCheckbox && enhancedScanCheckbox.checked;

                try {
                    // Inject Loading Template
                    const loadingTemplate = document.getElementById('loading-template');
                    resultsContainer.appendChild(loadingTemplate.content.cloneNode(true));

                    const response = await fetch('verify-cert.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hostname, port }),
                    });

                    const data = await response.json();

                    // Clear loading state
                    resultsContainer.innerHTML = '';

                    if (!response.ok) { throw new Error(data.error || `HTTP error! status: ${response.status}`); }

                    const newUrl = `${window.location.pathname}?hostname=${encodeURIComponent(hostname)}&port=${encodeURIComponent(port)}`;
                    history.replaceState(null, '', newUrl);

                    renderChainStatus(data.chainStatus, data.certificates);
                    renderConnectionInfo(data.connectionInfo, hostname);
                    renderServerHeader(data.serverHeader);
                    renderCertificates(data.certificates);

                    if (runEnhancedScan) {
                        // Show loading banner for enhanced scan
                        renderScanStatusBanner('loading');
                        runSslyzeScan(hostname, port);
                    }

                } catch (err) {
                    resultsContainer.innerHTML = ''; // Clear loading
                    renderError(err.message || 'An unexpected error occurred.');
                } finally {
                    setLoading(false);
                }
            };

            const renderChainStatus = (chainStatus, certificates) => {
                if (!chainStatus) return;

                const isRevoked = chainStatus.revocationStatus === 'revoked';
                const isExpired = chainStatus.issues && chainStatus.issues.some(issue => issue.toLowerCase().includes('expired'));
                const isCritical = isRevoked || isExpired;
                const isIncomplete = chainStatus.summary && chainStatus.summary.toLowerCase().includes('incomplete');

                // Determine which template to use based on status
                let templateId, statusMessage;
                if (chainStatus.isValid && !isCritical) {
                    templateId = 'chain-status-success-template';
                    statusMessage = chainStatus.summary;
                } else if (isCritical) {
                    templateId = 'chain-status-critical-template';
                    statusMessage = isExpired ? 'Certificate chain contains expired certificate(s)' : chainStatus.summary;
                } else {
                    templateId = 'chain-status-warning-template';
                    statusMessage = isIncomplete ? 'Incomplete certificate chain' : chainStatus.summary;
                }

                // If in non-success state, suppress the generic "correctly installed" message
                if (templateId !== 'chain-status-success-template' && statusMessage && statusMessage.includes('correctly installed')) {
                    statusMessage = '';
                }

                // Render status banner
                const template = document.getElementById(templateId);
                if (template) {
                    const node = template.content.cloneNode(true);
                    const msgEl = node.querySelector('.chain-status-message');

                    if (statusMessage) {
                        msgEl.textContent = statusMessage;
                        if (statusMessage.includes('correctly installed')) {
                            msgEl.classList.add('text-emerald-700', 'dark:text-emerald-400', 'font-medium');
                            msgEl.classList.remove('opacity-90');
                        }
                    } else {
                        msgEl.style.display = 'none';
                    }

                    const issuesList = node.querySelector('.chain-status-issues');
                    if (issuesList && chainStatus.issues) {
                        const filteredIssues = chainStatus.issues.filter(issue =>
                            !issue.toLowerCase().includes('expired') &&
                            !issue.toLowerCase().includes('incomplete') &&
                            !issue.toLowerCase().includes('missing intermediate')
                        );
                        filteredIssues.forEach(issue => {
                            const li = document.createElement('li');
                            li.textContent = issue;
                            issuesList.appendChild(li);
                        });
                    }

                    resultsContainer.appendChild(node);
                }

                // Render separate chain card
                if (certificates && certificates.length > 0) {
                    const cornerArrowSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 opacity-40"><path d="M9 18l6-6-6-6"/></svg>`;

                    const chainCard = document.createElement('div');
                    chainCard.className = 'bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg p-4 mb-4 text-sm';

                    let chainHtml = `
                        <div class="flex items-center font-semibold mb-3 text-slate-700 dark:text-slate-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 flex-shrink-0 text-slate-500">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                            Certificate Chain
                        </div>
                    `;

                    // Check if chain has a root certificate
                    const hasRoot = certificates.some(cert =>
                        cert.type === 'Root Certificate' || cert.type === 'Root'
                    );
                    const lastCert = certificates[certificates.length - 1];

                    certificates.forEach((cert, index) => {
                        const indent = 26 + (index * 20); // 26px base indent to align with header
                        const isExpiredCert = new Date(cert.validUntil) < new Date();
                        const expiredDate = isExpiredCert ? new Date(cert.validUntil).toLocaleDateString() : '';
                        const certId = `cert-${index}`;

                        // Check if this cert is revoked
                        const revocationCheck = chainStatus.revocationChecks?.find(r => r.index === index);
                        const isRevokedCert = revocationCheck?.status === 'revoked';

                        // Color classes based on status
                        // Link container colors (default state)
                        let linkClass = 'text-slate-700 dark:text-slate-300 hover:text-indigo-600 dark:hover:text-indigo-400';

                        // CN specific colors (overrides default if expired/revoked)
                        let cnClass = '';
                        let statusText = '';

                        if (isRevokedCert) {
                            cnClass = 'font-medium';
                            statusText = ` <span class="text-xs font-normal text-red-600 dark:text-red-400">(REVOKED)</span>`;
                        } else if (isExpiredCert) {
                            cnClass = 'font-medium';
                            statusText = ` <span class="text-xs font-normal text-red-600 dark:text-red-400">(expired ${expiredDate})</span>`;
                        } else {
                            cnClass = 'font-medium';
                        }

                        // Customize status for leaf certificate (index 0) if not expired/revoked
                        if (index === 0 && !isExpiredCert && !isRevokedCert) {
                            const validUntilDate = new Date(cert.validUntil);
                            const now = new Date();
                            const diffTime = validUntilDate - now;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            let colorClass = 'text-slate-700 dark:text-slate-300';
                            if (diffDays < 7) {
                                colorClass = 'text-amber-600 dark:text-amber-400';
                            }
                            statusText = ` <span class="text-xs font-normal ${colorClass}">(expires in ${diffDays} day${diffDays === 1 ? '' : 's'})</span>`;
                        }

                        const arrow = index > 0 ? cornerArrowSvg : '';
                        const typeLabel = cert.type.replace(' Certificate', '');

                        chainHtml += `
                            <div style="margin-left: ${indent}px" class="flex items-center py-0.5">
                                ${arrow}<a href="#${certId}" class="${linkClass} transition-colors"><span class="opacity-60">${typeLabel}:</span> <span class="${cnClass}">${cert.commonName}</span>${statusText}</a>
                            </div>
                        `;
                    });

                    // If chain is incomplete (missing intermediate), show it
                    if (isIncomplete && certificates.length === 1) {
                        const leafCert = certificates[0];
                        const issuerMatch = leafCert.issuer.match(/CN=([^,]+)/);
                        const issuerCn = issuerMatch ? issuerMatch[1] : leafCert.issuer;

                        chainHtml += `
                            <div style="margin-left: 46px" class="flex items-center py-0.5 text-slate-700 dark:text-slate-300">
                                ${cornerArrowSvg}<span><span class="opacity-60">Intermediate:</span> <span class="font-medium">${issuerCn}</span> <span class="text-amber-600 dark:text-amber-400 text-xs ml-1">(missing)</span></span>
                            </div>
                        `;
                    }

                    // If no root in chain, infer from last cert's issuer (cross-signed scenario)
                    if (!hasRoot && lastCert && lastCert.type !== 'Self-Signed Certificate') {
                        const issuerMatch = lastCert.issuer.match(/CN=([^,]+)/);
                        const rootCn = issuerMatch ? issuerMatch[1] : lastCert.issuer;

                        // Calculate indent: base 26 + (cert count * 20). 
                        // If we showed a "missing intermediate" row (isIncomplete=true), we need to add another level of indent.
                        const extraStep = (isIncomplete && certificates.length === 1) ? 1 : 0;
                        const lastIndent = 26 + ((certificates.length + extraStep) * 20);

                        // Only show inferred root if it's different from the last cert's CN
                        if (rootCn !== lastCert.commonName) {
                            chainHtml += `
                                <div style="margin-left: ${lastIndent}px" class="flex items-center py-0.5 text-slate-400 dark:text-slate-500">
                                    ${cornerArrowSvg}<span>Root: ${rootCn} <span class="text-xs ml-1">(not sent)</span></span>
                                </div>
                            `;
                        }
                    }

                    chainCard.innerHTML = chainHtml;
                    resultsContainer.appendChild(chainCard);
                }
            };

            // Render scan status banner (loading or results summary)
            const renderScanStatusBanner = (state, data = null) => {
                // Remove any existing scan status banner
                const existingBanner = document.getElementById('scan-status-banner');
                if (existingBanner) existingBanner.remove();

                const banner = document.createElement('div');
                banner.id = 'scan-status-banner';
                banner.className = 'mb-4';

                if (state === 'loading') {
                    banner.innerHTML = `
                        <div class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 text-indigo-800 dark:text-indigo-200 p-4 rounded-lg">
                            <div class="flex items-center">
                                <svg class="animate-spin h-5 w-5 mr-3 text-indigo-600 dark:text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <div>
                                    <h4 class="font-semibold text-sm">Enhanced Vulnerability Scan Running...</h4>
                                    <p class="text-xs opacity-75 mt-0.5">Checking protocols, ciphers, and vulnerabilities (may take up to 2 minutes)</p>
                                </div>
                            </div>
                        </div>`;
                } else if (state === 'complete' && data) {
                    // Use overallStatus and summary from backend
                    const statusIcons = {
                        'PASS': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
                        'INFO': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`,
                        'WARNING': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
                        'CRITICAL': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`
                    };
                    const statusColors = {
                        'PASS': { bg: 'bg-emerald-50 dark:bg-emerald-900/20', border: 'border-emerald-200 dark:border-emerald-800', text: 'text-emerald-800 dark:text-emerald-300' },
                        'INFO': { bg: 'bg-blue-50 dark:bg-blue-900/20', border: 'border-blue-200 dark:border-blue-800', text: 'text-blue-800 dark:text-blue-300' },
                        'WARNING': { bg: 'bg-amber-50 dark:bg-amber-900/20', border: 'border-amber-200 dark:border-amber-800', text: 'text-amber-800 dark:text-amber-300' },
                        'CRITICAL': { bg: 'bg-red-50 dark:bg-red-900/20', border: 'border-red-200 dark:border-red-800', text: 'text-red-800 dark:text-red-300' }
                    };
                    const statusStyle = statusColors[data.overallStatus] || statusColors['INFO'];
                    const statusIcon = statusIcons[data.overallStatus] || statusIcons['INFO'];

                    banner.innerHTML = `
                        <a href="#sslyze-results-container" onclick="document.getElementById('sslyze-results-container').scrollIntoView({behavior: 'smooth'}); return false;" 
                           class="${statusStyle.bg} ${statusStyle.border} ${statusStyle.text} border p-4 rounded-lg block hover:opacity-90 transition-opacity cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="mr-3">${statusIcon}</span>
                                    <div>
                                        <h4 class="font-semibold text-sm">Enhanced Scan Complete</h4>
                                        <p class="text-xs opacity-75 mt-0.5">${data.summary || 'Scan complete'} — Click to view details ↓</p>
                                    </div>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </div>
                        </a>`;
                } else if (state === 'error') {
                    banner.innerHTML = `
                        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-200 p-4 rounded-lg">
                            <div class="flex items-center">
                                <span class="text-xl mr-3">❌</span>
                                <div>
                                    <h4 class="font-semibold text-sm">Enhanced Scan Failed</h4>
                                    <p class="text-xs opacity-75 mt-0.5">${data?.message || 'An error occurred during the vulnerability scan'}</p>
                                </div>
                            </div>
                        </div>`;
                }

                // Insert after chain status (first child of results container, or just append)
                const firstChild = resultsContainer.firstChild;
                if (firstChild) {
                    // Find the chain status box and insert after it
                    const chainStatusBox = resultsContainer.querySelector('[class*="bg-emerald"], [class*="bg-amber"], [class*="bg-red"]');
                    if (chainStatusBox) {
                        chainStatusBox.after(banner);
                    } else {
                        resultsContainer.insertBefore(banner, firstChild);
                    }
                } else {
                    resultsContainer.appendChild(banner);
                }
            };

            const renderServerHeader = (serverHeader) => {
                if (!serverHeader) return;

                const serverDiv = document.createElement('div');
                serverDiv.className = 'bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 p-3 rounded-lg flex items-center mb-4 text-sm';
                serverDiv.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 flex-shrink-0 text-slate-500">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                    </svg>
                    <span><strong>HTTP Server:</strong> ${serverHeader}</span>
                `;
                resultsContainer.appendChild(serverDiv);
            };

            const renderConnectionInfo = (connectionInfo, hostname) => {
                if (!connectionInfo) return;

                const { connectedIp, dnsRecords } = connectionInfo;
                if (!connectedIp && (!dnsRecords?.A?.length && !dnsRecords?.AAAA?.length)) return;

                const containerId = 'dns-records-' + Date.now();
                const connectionDiv = document.createElement('div');
                connectionDiv.className = 'bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 p-3 rounded-lg mb-4 text-sm';

                // Count total records
                const aRecords = dnsRecords?.A || [];
                const aaaaRecords = dnsRecords?.AAAA || [];
                const totalRecords = aRecords.length + aaaaRecords.length;
                const showTable = totalRecords > 1;

                // Build DNS table HTML (only if 2+ records)
                let dnsHtml = '';
                if (showTable) {
                    const maxRows = Math.max(aRecords.length, aaaaRecords.length);
                    let tableRows = '';
                    for (let i = 0; i < maxRows; i++) {
                        const ipv4 = aRecords[i] || '';
                        const ipv6 = aaaaRecords[i] || '';
                        tableRows += `
                            <tr class="border-t border-slate-200 dark:border-slate-600">
                                <td class="py-1 pr-4">${ipv4}</td>
                                <td class="py-1">${ipv6}</td>
                            </tr>
                        `;
                    }
                    dnsHtml = `
                        <div id="${containerId}" class="hidden mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="text-slate-500 dark:text-slate-400">
                                        <th class="text-left font-medium pb-1 pr-4">IPv4 (A)</th>
                                        <th class="text-left font-medium pb-1">IPv6 (AAAA)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                connectionDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 flex-shrink-0 text-slate-500">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            <span><strong>Connected to:</strong> ${connectedIp || 'Unknown'}</span>
                        </div>
                        ${showTable ? `
                            <button onclick="toggleDnsRecords('${containerId}', this)" class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline flex items-center gap-1">
                                <span>Show DNS</span>
                                <svg class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 9-7 7-7-7"/>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                    ${dnsHtml}
                `;
                resultsContainer.appendChild(connectionDiv);
            };

            const renderCertificates = (certificates) => {
                const container = document.createDocumentFragment();
                const certCardTemplate = document.getElementById('certificate-card-template');

                certificates.forEach((cert, index) => {
                    const cardNode = certCardTemplate.content.cloneNode(true);
                    const headerContainer = cardNode.querySelector('.cert-header-container');
                    const dl = cardNode.querySelector('dl');
                    const card = cardNode.querySelector('.cert-card');

                    // Add ID for anchor linking from chain summary
                    card.id = `cert-${index}`;

                    const isSelfSigned = cert.type === 'Self-Signed Certificate';
                    let certTypeHTML = `<span class="cert-type">${cert.type}</span>`;
                    if (isSelfSigned) {
                        certTypeHTML = `<span class="cert-type text-red-600 dark:text-red-400 font-semibold">${cert.type}</span>`;
                    }

                    if (cert.pem) {
                        const blob = new Blob([cert.pem], { type: 'application/x-x509-ca-cert' });
                        const url = URL.createObjectURL(blob);
                        const filename = `${(cert.commonName || 'certificate').replace(/[^a-z0-9.-]/gi, '_')}.cer`;

                        // Create header container with flex layout
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'flex items-center justify-between flex-wrap gap-2';

                        // Left side: cert icon, type, and CN (not clickable)
                        const titleSpan = document.createElement('span');
                        titleSpan.className = 'flex items-center text-lg leading-6 font-medium text-slate-900 dark:text-white';
                        titleSpan.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="cert-icon mr-2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                            ${certTypeHTML}: <span class="cert-common-name ml-2 text-slate-700 dark:text-slate-300 font-normal">${cert.commonName}</span>
                        `;

                        // Right side: visible download button (icon only)
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = filename;
                        downloadLink.title = "Download Certificate";
                        downloadLink.className = 'text-slate-400 hover:text-indigo-600 dark:text-slate-500 dark:hover:text-indigo-400 transition-colors';
                        downloadLink.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        `;

                        headerDiv.appendChild(titleSpan);
                        headerDiv.appendChild(downloadLink);
                        headerContainer.appendChild(headerDiv);
                    } else {
                        headerContainer.innerHTML = `<h3 class="text-lg leading-6 font-medium text-slate-900 dark:text-white flex items-center">...</h3>`;
                    }

                    const isLeaf = cert.type === 'Leaf' || isSelfSigned;

                    if (isLeaf) {
                        card.classList.add('border-indigo-200', 'dark:border-indigo-900', 'ring-1', 'ring-indigo-500/20');
                        cardNode.querySelector('.cert-icon').classList.add('text-indigo-600', 'dark:text-indigo-400');
                    } else {
                        card.classList.add('border-slate-200', 'dark:border-slate-700');
                        cardNode.querySelector('.cert-icon').classList.add('text-slate-400', 'dark:text-slate-500');
                    }

                    dl.appendChild(createDetailRow('Common Name', cert.commonName));
                    if (cert.organization && cert.organization !== 'N/A') {
                        dl.appendChild(createDetailRow('Organization', cert.organization));
                    }
                    if (isLeaf) {
                        dl.appendChild(createDetailRow('Alternative Names', cert.alternativeNames.length > 0 ? cert.alternativeNames.join(', ') : 'N/A'));
                    }

                    const serialNumberDecimal = cert.serialNumberHex ? BigInt('0x' + cert.serialNumberHex.replace(/[^0-9a-fA-F]/g, '')).toString() : 'N/A';
                    const serialNumberHTML = `<span class="text-xs">${cert.serialNumberHex}</span> <br> <span class="text-slate-500 text-xs">(Decimal: ${serialNumberDecimal})</span>`;
                    dl.appendChild(createDetailRow('Serial Number', serialNumberHTML));

                    const validFromDate = new Date(cert.validFrom);
                    const validUntilDate = new Date(cert.validUntil);
                    const isExpired = validUntilDate < new Date();
                    const validUntilHTML = `<span class="${isExpired ? 'text-red-600 dark:text-red-400 font-semibold' : ''}">${validUntilDate.toUTCString()}</span>`;

                    dl.appendChild(createDetailRow('Valid From', validFromDate.toUTCString()));
                    dl.appendChild(createDetailRow('Valid Until', validUntilHTML));
                    dl.appendChild(createDetailRow('Public Key', cert.publicKey));
                    dl.appendChild(createDetailRow('Issuer', cert.issuer));
                    dl.appendChild(createDetailRow('Signature Algorithm', cert.signatureAlgorithm));

                    container.appendChild(cardNode);
                });
                resultsContainer.appendChild(container);
            };

            const runSslyzeScan = async (hostname, port) => {
                // Clear any previous results (banner handles loading state)
                sslyzeResultsContainer.innerHTML = '';

                try {
                    const isPostgres = parseInt(port) === 5432;
                    const response = await fetch('sslyze-scan.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hostname, port, isPostgres }),
                    });

                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Server returned non-JSON response.');
                    }

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `SSLyze error: ${response.status}`);
                    if (data.success === false && data.error) {
                        renderScanStatusBanner('error', { message: data.error });
                        sslyzeResultsContainer.innerHTML = `<div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-300 dark:border-amber-700 text-amber-800 dark:text-amber-200 p-4 rounded-lg"><h4 class="font-bold text-sm">Vulnerability Scan Notice</h4><p class="text-sm mt-1">${data.error}</p></div>`;
                        return;
                    }
                    renderScanStatusBanner('complete', data);
                    renderSslyzeResults(data);

                } catch (err) {
                    renderScanStatusBanner('error', { message: err.message });
                    sslyzeResultsContainer.innerHTML = `<div class="bg-red-50 dark:bg-red-900/20 border border-red-300 dark:border-red-800 text-red-800 dark:text-red-200 p-4 rounded-lg"><h4 class="font-bold text-sm">Vulnerability Scan Failed</h4><p class="text-sm mt-1">${err.message}</p></div>`;
                }
            };

            const renderSslyzeResults = (data) => {
                const template = document.getElementById('sslyze-results-template');
                const node = template.content.cloneNode(true);
                const contentDiv = node.querySelector('.sslyze-content');

                let html = '';

                if (data.protocolSupport && data.protocolSupport.length > 0) {
                    html += `<h4 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mt-4 mb-2">Protocol Support</h4>`;
                    html += `<div class="overflow-hidden rounded-lg border border-slate-200 dark:border-slate-700"><table class="min-w-full text-sm divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-900/50"><tr>
                            <th class="px-4 py-3 text-left font-medium text-slate-500 dark:text-slate-400">Protocol</th>
                            <th class="px-4 py-3 text-left font-medium text-slate-500 dark:text-slate-400">Status</th>
                            <th class="px-4 py-3 text-left font-medium text-slate-500 dark:text-slate-400">Ciphers</th>
                        </tr></thead><tbody class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-800">`;

                    data.protocolSupport.forEach((proto, index) => {
                        let statusClass, statusText;
                        // Determine if protocol is obsolete (SSL) or deprecated (old TLS)
                        const isObsolete = proto.protocol.startsWith('SSL');
                        const labelText = isObsolete ? 'Obsolete' : 'Deprecated';

                        // Build protocol name with obsolete/deprecated label if applicable
                        const protocolName = proto.deprecated
                            ? `${proto.protocol} <span class="text-slate-500 dark:text-slate-400 text-xs font-normal">(${labelText})</span>`
                            : proto.protocol;

                        // SVG icons for status
                        const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
                        const warnIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`;
                        const blockIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>`;
                        const infoIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;

                        if (proto.supported) {
                            if (proto.deprecated) {
                                statusClass = 'text-amber-600 dark:text-amber-400';
                                statusText = `${warnIcon}Enabled`;
                            } else {
                                statusClass = 'text-emerald-600 dark:text-emerald-400';
                                statusText = `${checkIcon}Enabled`;
                            }
                        } else {
                            if (proto.deprecated) {
                                // Deprecated protocol disabled = good
                                statusClass = 'text-emerald-600 dark:text-emerald-400';
                                statusText = `${blockIcon}Disabled`;
                            } else {
                                // Modern protocol disabled = informational, not an error
                                statusClass = 'text-slate-500 dark:text-slate-400';
                                statusText = `${infoIcon}Disabled`;
                            }
                        }
                        const cipherCount = proto.cipherCount || 0;
                        const cipherClickable = cipherCount > 0 ?
                            `<button class="text-indigo-600 dark:text-indigo-400 underline hover:text-indigo-800 dark:hover:text-indigo-300 cursor-pointer" onclick="toggleCipherList('cipher-list-${index}')">${cipherCount}</button>` :
                            '-';
                        const cipherListHtml = proto.ciphers && proto.ciphers.length > 0 ?
                            `<div id="cipher-list-${index}" class="hidden mt-2 p-3 bg-slate-50 dark:bg-black rounded border border-slate-100 dark:border-slate-700 text-xs text-slate-600 dark:text-slate-300">
                                <strong class="block mb-1">${proto.protocol} Ciphers:</strong>
                                <ul class="list-disc list-inside space-y-0.5 font-mono">
                                    ${proto.ciphers.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>` : '';
                        html += `<tr>
                            <td class="px-4 py-3 text-slate-900 dark:text-slate-200">${protocolName}</td>
                            <td class="px-4 py-3 ${statusClass} font-medium">${statusText}</td>
                            <td class="px-4 py-3 text-slate-700 dark:text-slate-300">${cipherClickable}</td>
                        </tr>
                        <tr class="${proto.ciphers && proto.ciphers.length > 0 ? '' : 'hidden'}">
                            <td colspan="3" class="px-4 py-0 border-0">${cipherListHtml}</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                }

                if (data.securityChecks && data.securityChecks.length > 0) {
                    html += `<h4 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mt-6 mb-2">Security Checks</h4>`;
                    html += `<div class="overflow-hidden rounded-lg border border-slate-200 dark:border-slate-700"><table class="min-w-full text-sm divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-900/50"><tr>
                            <th class="px-4 py-3 text-left font-medium text-slate-500 dark:text-slate-400">Check</th>
                            <th class="px-4 py-3 text-left font-medium text-slate-500 dark:text-slate-400">Severity</th>
                            <th class="px-4 py-3 text-left font-medium text-slate-500 dark:text-slate-400">Status</th>
                            <th class="px-4 py-3 text-left font-medium text-slate-500 dark:text-slate-400">Details</th>
                        </tr></thead><tbody class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-800">`;
                    data.securityChecks.forEach(check => {
                        // Severity - neutral styling (status PASS/FAIL provides the visual signal)
                        const severityColor = 'text-slate-600 dark:text-slate-400';

                        // Status with SVG icons
                        let statusClass, statusIcon, statusLabel;
                        if (check.passed) {
                            statusClass = 'text-emerald-600 dark:text-emerald-400';
                            statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
                            statusLabel = 'PASS';
                        } else if (check.severity === 'INFO') {
                            statusClass = 'text-slate-600 dark:text-slate-400';
                            statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;
                            statusLabel = 'INFO';
                        } else {
                            statusClass = 'text-red-600 dark:text-red-400';
                            statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
                            statusLabel = 'FAIL';
                        }

                        html += `<tr>
                            <td class="px-4 py-3 font-medium text-slate-900 dark:text-slate-200">${check.name}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 rounded-md text-xs font-semibold ${severityColor}">${check.severity}</span></td>
                            <td class="px-4 py-3 ${statusClass} font-bold">${statusIcon}${statusLabel}</td>
                            <td class="px-4 py-3 text-slate-600 dark:text-slate-400">${check.description}</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                }

                contentDiv.innerHTML = html;
                sslyzeResultsContainer.innerHTML = '';
                sslyzeResultsContainer.appendChild(node);
            };

            const renderError = (message) => {
                resultsContainer.innerHTML = '';
                const errorTemplate = document.getElementById('error-template');
                const errorNode = errorTemplate.content.cloneNode(true);
                errorNode.querySelector('.error-message').innerHTML = message;
                resultsContainer.appendChild(errorNode);
            };

            const setLoading = (isLoading) => {
                submitButton.disabled = isLoading;
                buttonText.classList.toggle('hidden', isLoading);
                buttonLoader.classList.toggle('hidden', !isLoading);
            };

            function createDetailRow(label, valueHTML) {
                const row = document.createElement('div');
                row.className = 'py-3 sm:grid sm:grid-cols-3 sm:gap-4';
                row.innerHTML = `<dt class="text-sm font-medium text-slate-500 dark:text-slate-400">${label}</dt>
                                 <dd class="mt-1 text-sm text-slate-800 dark:text-slate-200 sm:mt-0 sm:col-span-2 break-words">${valueHTML}</dd>`;
                return row;
            }

            form.addEventListener('submit', handleVerify);
        }

        // ============================================================================
        // ASN.1 OID MAPPINGS AND PARSING UTILITIES
        // ============================================================================

        /**
         * Mappings for common ASN.1 OIDs (EC curves, signature algorithms, DN attributes, extensions).
         * Used by the ASN.1 fallback parsers for EC certificates and CSRs.
         */
        const OID_MAP = {
            // EC Curves
            '1.2.840.10045.3.1.7': 'P-256 (prime256v1)',
            '1.3.132.0.34': 'P-384 (secp384r1)',
            '1.3.132.0.35': 'P-521 (secp521r1)',
            '1.2.840.10045.3.1.1': 'P-192 (prime192v1)',
            '1.3.132.0.10': 'secp256k1',
            // Signature Algorithms
            '1.2.840.10045.4.3.2': 'ECDSA with SHA-256',
            '1.2.840.10045.4.3.3': 'ECDSA with SHA-384',
            '1.2.840.10045.4.3.4': 'ECDSA with SHA-512',
            '1.2.840.10045.4.1': 'ECDSA with SHA-1',
            '1.2.840.113549.1.1.11': 'RSA with SHA-256',
            '1.2.840.113549.1.1.12': 'RSA with SHA-384',
            '1.2.840.113549.1.1.13': 'RSA with SHA-512',
            '1.2.840.113549.1.1.5': 'RSA with SHA-1',
            // Public Key Types
            '1.2.840.10045.2.1': 'EC Public Key',
            '1.2.840.113549.1.1.1': 'RSA',
            // DN Attributes
            '2.5.4.3': 'CN',
            '2.5.4.6': 'C',
            '2.5.4.7': 'L',
            '2.5.4.8': 'ST',
            '2.5.4.10': 'O',
            '2.5.4.11': 'OU',
            '2.5.4.5': 'serialNumber',
            '1.2.840.113549.1.9.1': 'emailAddress',
            // Extensions
            '2.5.29.17': 'subjectAltName',
            '2.5.29.19': 'basicConstraints',
            '2.5.29.15': 'keyUsage',
            '2.5.29.37': 'extKeyUsage',
            '2.5.29.14': 'subjectKeyIdentifier',
            '2.5.29.35': 'authorityKeyIdentifier',
            '2.5.29.31': 'cRLDistributionPoints',
            '1.3.6.1.5.5.7.1.1': 'authorityInfoAccess',
        };

        // Helper: Get bytes string from value (handles both string and ByteStringBuffer)
        function asn1GetBytes(value) {
            if (typeof value === 'string') return value;
            if (value && typeof value.getBytes === 'function') return value.getBytes();
            if (value && typeof value.data === 'string') return value.data;
            return String(value || '');
        }

        // Helper: Extract OID from ASN.1 node
        function asn1GetOid(node) {
            if (node.type === forge.asn1.Type.OID) {
                const bytes = asn1GetBytes(node.value);
                return forge.asn1.derToOid(bytes);
            }
            return null;
        }

        // Helper: Extract string value from ASN.1 node
        function asn1GetString(node) {
            const stringTypes = [
                forge.asn1.Type.UTF8,
                forge.asn1.Type.PRINTABLESTRING,
                forge.asn1.Type.IA5STRING,
                forge.asn1.Type.T61STRING,
                forge.asn1.Type.BMPSTRING,
            ];
            if (stringTypes.includes(node.type)) {
                return asn1GetBytes(node.value);
            }
            return null;
        }

        // Helper: Parse Distinguished Name from ASN.1
        function parseDistinguishedName(rdnSequence) {
            const attrs = [];
            if (!rdnSequence || !rdnSequence.value) return attrs;

            for (const rdn of rdnSequence.value) {
                if (rdn.value) {
                    for (const atv of rdn.value) {
                        if (atv.value && atv.value.length >= 2) {
                            const oid = asn1GetOid(atv.value[0]);
                            const value = asn1GetString(atv.value[1]) || asn1GetBytes(atv.value[1].value);
                            const shortName = OID_MAP[oid] || oid;
                            attrs.push({ shortName, value, oid });
                        }
                    }
                }
            }
            return attrs;
        }

        // Helper: Parse validity period from ASN.1
        function parseValidity(validityNode) {
            const result = { notBefore: null, notAfter: null };
            if (!validityNode || !validityNode.value || validityNode.value.length < 2) return result;

            const parseAsn1Time = (timeNode) => {
                const timeStr = asn1GetBytes(timeNode.value);
                if (timeNode.type === forge.asn1.Type.UTCTIME) {
                    // YYMMDDhhmmssZ - 2-digit year
                    const year = parseInt(timeStr.substring(0, 2));
                    const fullYear = year >= 50 ? 1900 + year : 2000 + year;
                    return new Date(Date.UTC(
                        fullYear,
                        parseInt(timeStr.substring(2, 4)) - 1,
                        parseInt(timeStr.substring(4, 6)),
                        parseInt(timeStr.substring(6, 8)),
                        parseInt(timeStr.substring(8, 10)),
                        parseInt(timeStr.substring(10, 12))
                    ));
                } else if (timeNode.type === forge.asn1.Type.GENERALIZEDTIME) {
                    // YYYYMMDDhhmmssZ - 4-digit year
                    return new Date(Date.UTC(
                        parseInt(timeStr.substring(0, 4)),
                        parseInt(timeStr.substring(4, 6)) - 1,
                        parseInt(timeStr.substring(6, 8)),
                        parseInt(timeStr.substring(8, 10)),
                        parseInt(timeStr.substring(10, 12)),
                        parseInt(timeStr.substring(12, 14))
                    ));
                }
                return null;
            };

            result.notBefore = parseAsn1Time(validityNode.value[0]);
            result.notAfter = parseAsn1Time(validityNode.value[1]);
            return result;
        }

        // Helper: Parse public key info from ASN.1
        function parsePublicKeyInfo(pubKeyNode) {
            if (!pubKeyNode || !pubKeyNode.value || pubKeyNode.value.length < 1) {
                return { algorithm: 'Unknown', details: '' };
            }

            const algorithmNode = pubKeyNode.value[0];
            if (!algorithmNode || !algorithmNode.value || algorithmNode.value.length < 1) {
                return { algorithm: 'Unknown', details: '' };
            }

            const algOid = asn1GetOid(algorithmNode.value[0]);
            const algName = OID_MAP[algOid] || algOid;

            if (algName === 'EC Public Key' && algorithmNode.value.length >= 2) {
                const curveOid = asn1GetOid(algorithmNode.value[1]);
                const curveName = OID_MAP[curveOid] || curveOid;
                return { algorithm: 'ECDSA', details: curveName };
            }

            return { algorithm: algName, details: '' };
        }

        // Helper: Parse extensions from ASN.1
        function parseExtensionsAsn1(extensionsNode) {
            const extensions = [];
            if (!extensionsNode || !extensionsNode.value) return extensions;

            // Extensions are wrapped in a context-specific tag [3]
            let extSeq = extensionsNode;
            if (extensionsNode.type === 3 && extensionsNode.tagClass === forge.asn1.Class.CONTEXT_SPECIFIC) {
                extSeq = extensionsNode.value[0];
            }

            if (!extSeq || !extSeq.value) return extensions;

            for (const ext of extSeq.value) {
                if (!ext.value || ext.value.length < 2) continue;

                // console.log('Ext Node 0:', ext.value[0]); // Debug OID node
                const oid = asn1GetOid(ext.value[0]);
                const name = OID_MAP[oid] || oid;
                let critical = false;
                let valueNode = ext.value[1];

                if (ext.value.length >= 3 && ext.value[1].type === forge.asn1.Type.BOOLEAN) {
                    critical = ext.value[1].value === '\xff';
                    valueNode = ext.value[2];
                }

                const extInfo = { name, oid, critical, details: [] };

                // Parse SAN extension
                if (oid === '2.5.29.17' && valueNode.type === forge.asn1.Type.OCTETSTRING) {
                    try {
                        const sanAsn1 = forge.asn1.fromDer(forge.util.createBuffer(valueNode.value));
                        if (sanAsn1.value) {
                            for (const altName of sanAsn1.value) {
                                const tagClass = altName.tagClass;
                                const tagNumber = altName.type;
                                if (tagClass === forge.asn1.Class.CONTEXT_SPECIFIC) {
                                    if (tagNumber === 2) { // DNS
                                        extInfo.details.push(`DNS: ${altName.value}`);
                                    } else if (tagNumber === 7) { // IP
                                        const bytes = asn1GetBytes(altName.value);
                                        if (bytes.length === 4) {
                                            extInfo.details.push(`IP: ${bytes.charCodeAt(0)}.${bytes.charCodeAt(1)}.${bytes.charCodeAt(2)}.${bytes.charCodeAt(3)}`);
                                        }
                                    } else if (tagNumber === 1) { // Email
                                        extInfo.details.push(`Email: ${altName.value}`);
                                    }
                                }
                            }
                        }
                    } catch (e) { /* ignore parsing errors */ }
                }

                // Parse Basic Constraints
                if (oid === '2.5.29.19' && valueNode.type === forge.asn1.Type.OCTETSTRING) {
                    try {
                        const bcAsn1 = forge.asn1.fromDer(forge.util.createBuffer(valueNode.value));
                        if (bcAsn1.value && bcAsn1.value.length > 0) {
                            const isCA = bcAsn1.value[0].value === '\xff';
                            extInfo.details.push(`CA: ${isCA ? 'Yes' : 'No'}`);
                        } else {
                            extInfo.details.push('CA: No');
                        }
                    } catch (e) {
                        extInfo.details.push('CA: No');
                    }
                }

                extensions.push(extInfo);
            }

            return extensions;
        }

        // Fallback: Parse EC certificate using raw ASN.1
        function parseEcCertificateAsn1(pem) {
            // Extract base64 content
            const base64 = pem.replace(/-----BEGIN CERTIFICATE-----/, '')
                .replace(/-----END CERTIFICATE-----/, '')
                .replace(/[\r\n\s]/g, '');
            const derBytes = forge.util.decode64(base64);
            const asn1 = forge.asn1.fromDer(forge.util.createBuffer(derBytes));

            // Certificate structure: SEQUENCE { tbsCertificate, signatureAlgorithm, signature }
            const tbsCert = asn1.value[0];
            const sigAlgNode = asn1.value[1];

            // TBSCertificate structure (may have version as first element)
            let idx = 0;
            let version = 1;

            // Check for explicit version tag [0]
            if (tbsCert.value[0].tagClass === forge.asn1.Class.CONTEXT_SPECIFIC && tbsCert.value[0].type === 0) {
                const verBytes = asn1GetBytes(tbsCert.value[0].value[0].value);
                version = verBytes.charCodeAt(0) + 1;
                idx = 1;
            }

            // Serial Number
            const serialNode = tbsCert.value[idx];
            let serialNumber = '';
            const serialBytes = asn1GetBytes(serialNode.value);
            for (let i = 0; i < serialBytes.length; i++) {
                const byte = serialBytes.charCodeAt(i);
                serialNumber += byte.toString(16).padStart(2, '0');
            }
            idx++;

            // Signature Algorithm (in TBS)
            const tbsSigAlg = tbsCert.value[idx];
            const sigAlgOid = asn1GetOid(tbsSigAlg.value[0]);
            const signatureAlgorithm = OID_MAP[sigAlgOid] || sigAlgOid;
            idx++;

            // Issuer
            const issuerNode = tbsCert.value[idx];
            const issuer = parseDistinguishedName(issuerNode);
            idx++;

            // Validity
            const validityNode = tbsCert.value[idx];
            const validity = parseValidity(validityNode);
            idx++;

            // Subject
            const subjectNode = tbsCert.value[idx];
            const subject = parseDistinguishedName(subjectNode);
            idx++;

            // Public Key Info
            const pubKeyNode = tbsCert.value[idx];
            const publicKey = parsePublicKeyInfo(pubKeyNode);
            idx++;

            // Extensions (optional, look for context-specific tag [3])
            let extensions = [];
            for (let i = idx; i < tbsCert.value.length; i++) {
                const node = tbsCert.value[i];
                if (node.type === 3 && node.tagClass === forge.asn1.Class.CONTEXT_SPECIFIC) {
                    extensions = parseExtensionsAsn1(node);
                    break;
                }
            }

            return {
                version,
                serialNumber: serialNumber.toUpperCase(),
                signatureAlgorithm,
                issuer,
                validity,
                subject,
                publicKey,
                extensions,
                isEc: true
            };
        }

        // Fallback: Parse EC CSR using raw ASN.1
        function parseEcCsrAsn1(pem) {
            // Extract base64 content
            const base64 = pem.replace(/-----BEGIN CERTIFICATE REQUEST-----/, '')
                .replace(/-----END CERTIFICATE REQUEST-----/, '')
                .replace(/[\r\n\s]/g, '');
            const derBytes = forge.util.decode64(base64);
            const asn1 = forge.asn1.fromDer(forge.util.createBuffer(derBytes));

            // CSR structure: SEQUENCE { certificationRequestInfo, signatureAlgorithm, signature }
            const certReqInfo = asn1.value[0];
            const sigAlgNode = asn1.value[1];

            // Signature Algorithm
            const sigAlgOid = asn1GetOid(sigAlgNode.value[0]);
            const signatureAlgorithm = OID_MAP[sigAlgOid] || sigAlgOid;

            // CertificationRequestInfo: SEQUENCE { version, subject, subjectPKInfo, attributes }
            let idx = 0;

            // Version
            const versionNode = certReqInfo.value[idx];
            const verBytes = asn1GetBytes(versionNode.value);
            const version = verBytes.charCodeAt(0) + 1;
            idx++;

            // Subject
            const subjectNode = certReqInfo.value[idx];
            const subject = parseDistinguishedName(subjectNode);
            idx++;

            // Public Key Info
            const pubKeyNode = certReqInfo.value[idx];
            const publicKey = parsePublicKeyInfo(pubKeyNode);
            idx++;

            // Attributes (extensions) - optional
            let extensions = [];
            if (idx < certReqInfo.value.length) {
                const attrsNode = certReqInfo.value[idx];
                if (attrsNode && attrsNode.value) {
                    for (const attr of attrsNode.value) {
                        if (attr.value && attr.value.length >= 2) {
                            const attrOid = asn1GetOid(attr.value[0]);
                            // Extension request OID: 1.2.840.113549.1.9.14
                            if (attrOid === '1.2.840.113549.1.9.14' && attr.value[1].value) {
                                const extSeq = attr.value[1].value[0];
                                if (extSeq && extSeq.value) {
                                    for (const ext of extSeq.value) {
                                        if (!ext.value || ext.value.length < 2) continue;
                                        const oid = asn1GetOid(ext.value[0]);
                                        const name = OID_MAP[oid] || oid;
                                        const extInfo = { name, oid, critical: false, details: [] };

                                        // Parse SAN in CSR
                                        if (oid === '2.5.29.17') {
                                            let valueNode = ext.value[1];
                                            if (ext.value.length >= 3) valueNode = ext.value[2];
                                            if (valueNode.type === forge.asn1.Type.OCTETSTRING) {
                                                try {
                                                    const sanAsn1 = forge.asn1.fromDer(forge.util.createBuffer(valueNode.value));
                                                    if (sanAsn1.value) {
                                                        for (const altName of sanAsn1.value) {
                                                            const tagNumber = altName.type;
                                                            if (altName.tagClass === forge.asn1.Class.CONTEXT_SPECIFIC && tagNumber === 2) {
                                                                extInfo.details.push(`DNS: ${altName.value}`);
                                                            }
                                                        }
                                                    }
                                                } catch (e) { /* ignore */ }
                                            }
                                        }
                                        extensions.push(extInfo);
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return {
                version,
                signatureAlgorithm,
                subject,
                publicKey,
                extensions,
                isEc: true
            };
        }

        // ============================================================================
        // PEM DECODER (Tab 2)
        // ============================================================================

        /**
         * Main entry point for decoding PEM-formatted certificates and CSRs.
         * Attempts forge.pki parsing first, falls back to raw ASN.1 for EC certs.
         */
        // --- Constants & Helpers ---

        const BYTES_TO_HEX = (bytes) => {
            let hex = '';
            // Handle Forge ByteBuffer, raw string, or array
            const data = bytes.data || bytes;
            for (let i = 0; i < data.length; i++) {
                hex += data.charCodeAt(i).toString(16).toLowerCase().padStart(2, '0');
            }
            return hex;
        };

        const POLICY_MAP = {
            '2.5.29.32.0': 'anyPolicy',
            '2.23.140.1.2.1': 'Domain Validated',
            '2.23.140.1.2.2': 'Organization Validated',
            '2.23.140.1.2.3': 'Individual Validated',
            '2.23.140.1.1': 'Extended Validation',
        };

        const KEY_USAGE_NAMES = {
            digitalSignature: 'Digital Signature',
            nonRepudiation: 'Non Repudiation',
            keyEncipherment: 'Key Encipherment',
            dataEncipherment: 'Data Encipherment',
            keyAgreement: 'Key Agreement',
            keyCertSign: 'Certificate Sign',
            cRLSign: 'CRL Sign',
            encipherOnly: 'Encipher Only',
            decipherOnly: 'Decipher Only'
        };

        const EXT_KEY_USAGE_NAMES = {
            serverAuth: 'Server Authentication',
            clientAuth: 'Client Authentication',
            codeSigning: 'Code Signing',
            emailProtection: 'Email Protection',
            timeStamping: 'Timestamping'
        };

        const getAuthorityKeyIdentifier = (cert) => {
            const akiOid = '2.5.29.35';
            const ext = cert.extensions.find(e => e.id === akiOid || e.name === 'authorityKeyIdentifier');
            if (!ext) return null;

            if (ext.keyIdentifier) {
                return BYTES_TO_HEX(ext.keyIdentifier);
            }

            // Fallback: Manual ASN.1 parsing
            try {
                const asn1 = forge.asn1.fromDer(ext.value);
                if (asn1.type === forge.asn1.Type.SEQUENCE) {
                    for (let i = 0; i < asn1.value.length; i++) {
                        const item = asn1.value[i];
                        if (item.tagClass === forge.asn1.Class.CONTEXT_SPECIFIC && item.type === 0) {
                            return BYTES_TO_HEX(item.value);
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to parse AKI manually', e);
            }
            return null;
        };

        const getCertificatePolicies = (ext) => {
            let details = '';
            if (!ext.value) return details;

            try {
                const policies = forge.asn1.fromDer(ext.value);
                if (policies.type === forge.asn1.Type.SEQUENCE) {
                    policies.value.forEach((policy) => {
                        const policyOid = forge.asn1.derToOid(policy.value[0].value);
                        const displayName = POLICY_MAP[policyOid] || policyOid;
                        details += `<div class="ml-4">- ${displayName}</div>`;

                        if (policy.value[1] && policy.value[1].type === forge.asn1.Type.SEQUENCE) {
                            const qualifiers = policy.value[1];
                            qualifiers.value.forEach(qualifier => {
                                const qualifierId = forge.asn1.derToOid(qualifier.value[0].value);
                                // CPS Pointer (1.3.6.1.5.5.7.2.1)
                                if (qualifierId === '1.3.6.1.5.5.7.2.1') {
                                    const qualifierValue = qualifier.value[1].value;
                                    details += `<div class="ml-8 text-xs text-slate-500 dark:text-slate-400">CPS: ${qualifierValue}</div>`;
                                }
                                // User Notice (1.3.6.1.5.5.7.2.2)
                                else if (qualifierId === '1.3.6.1.5.5.7.2.2') {
                                    try {
                                        if (qualifier.value[1].value[0] && qualifier.value[1].value[0].value) {
                                            const userNotice = qualifier.value[1].value[0].value;
                                            if (typeof userNotice === 'string') {
                                                details += `<div class="ml-8 text-xs text-slate-500 dark:text-slate-400">User Notice: ${userNotice}</div>`;
                                            }
                                        }
                                    } catch (e) { /* Ignore user notice parsing error */ }
                                }
                            });
                        }
                    });
                }
            } catch (e) {
                console.error('Failed to parse Certificate Policies', e);
            }
            return details;
        };

        function decodeCert() {

            const output = document.getElementById('decoderOutput');
            output.innerHTML = '';
            output.className = 'mt-6'; // Reset

            let pem = document.getElementById('certInput').value.trim();
            // Replace literal "\n" characters with actual newlines to support single-line copy-pastes
            pem = pem.replace(/\\n/g, '\n');
            document.getElementById('certInput').value = pem;

            if (!pem) {
                output.innerHTML = `<div class="p-4 text-sm text-red-700 dark:text-red-300 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800" role="alert"><strong class="font-bold">Error:</strong> Please paste a certificate or CSR.</div>`;
                return;
            }

            if (pem.includes('-----BEGIN CERTIFICATE REQUEST-----')) {
                decodeCsr(pem);
                return;
            }

            if (!pem.includes('-----BEGIN CERTIFICATE-----')) {
                pem = pem.replace(/-----(BEGIN|END) CERTIFICATE-----/g, '').replace(/[\r\n\s]/g, '');
                pem = pem.match(/.{1,64}/g).join('\n');
                pem = '-----BEGIN CERTIFICATE-----\n' + pem + '\n-----END CERTIFICATE-----';
            }

            try {
                // Pre-process parsing options for Forge to ensure extensions are fully parsed
                const cert = forge.pki.certificateFromPem(pem);

                let html = '<div class="bg-slate-50 dark:bg-black rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">';



                // Use global helper functions: createSection, sortAttributes
                let subjectContent = sortAttributes(cert.subject.attributes).map(attr => `<div>${attr.shortName || attr.name} = <span class="break-all">${attr.value}</span></div>`).join('');
                html += createSection('Subject', subjectContent);

                let issuerContent = sortAttributes(cert.issuer.attributes).map(attr => `<div>${attr.shortName || attr.name} = <span class="break-all">${attr.value}</span></div>`).join('');
                html += createSection('Issuer', issuerContent);

                html += createSection('Serial Number', `<div>${cert.serialNumber}</div>`);

                const isExpired = new Date() > new Date(cert.validity.notAfter);
                const validityDateClass = isExpired ? 'text-red-600 dark:text-red-400 font-bold' : '';
                let validityContent = `<div>Valid From: ${new Date(cert.validity.notBefore).toUTCString()}</div>`;
                validityContent += `<div>Valid To: <span class="${validityDateClass}">${new Date(cert.validity.notAfter).toUTCString()}</span></div>`;
                html += createSection('Validity Period', validityContent);

                const pubKey = cert.publicKey;
                let pubAlg = 'Unknown';
                if (pubKey.n) pubAlg = `RSA (${pubKey.n.toString(2).length} bits)`;
                else if (pubKey.ecparams) {
                    const curveOid = forge.pki.oids[pubKey.ecparams.curve.oid];
                    pubAlg = `ECDSA (${curveOid || 'Unknown Curve'})`;
                }
                html += createSection('Public Key Info', `<div>${pubAlg}</div>`);

                let extensionsContent = '';
                cert.extensions.forEach(ext => {
                    let extDetails = '';
                    switch (ext.name) {
                        case 'subjectKeyIdentifier':
                            extDetails = `<div class="ml-4">${ext.subjectKeyIdentifier}</div>`;
                            break;
                        case 'authorityKeyIdentifier':
                            // Use helper to support both Forge-parsed and manual fallback parsing
                            const akiValue = getAuthorityKeyIdentifier(cert);
                            if (akiValue) {
                                extDetails = `<div class="ml-4">Key Identifier: ${akiValue}</div>`;
                            }
                            break;
                        case 'keyUsage':
                            for (const usage in ext) {
                                if (ext[usage] === true && usage !== 'name' && usage !== 'critical') {
                                    const friendlyName = KEY_USAGE_NAMES[usage] || usage.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                    extDetails += `<div class="ml-4">- ${friendlyName}</div>`;
                                }
                            }
                            break;
                        case 'extKeyUsage':
                            for (const usage in EXT_KEY_USAGE_NAMES) {
                                if (ext[usage] === true) {
                                    extDetails += `<div class="ml-4">- ${EXT_KEY_USAGE_NAMES[usage]}</div>`;
                                }
                            }
                            if (ext.extra) {
                                ext.extra.forEach(oid => {
                                    const oidName = forge.pki.oids[oid] || oid;
                                    if (!Object.keys(EXT_KEY_USAGE_NAMES).some(key => forge.pki.oids[key] === oid)) {
                                        extDetails += `<div class="ml-4">- ${oidName}</div>`;
                                    }
                                });
                            }
                            break;
                        case 'cRLDistributionPoints':
                            if (ext.uris) {
                                ext.uris.forEach(uri => extDetails += `<div class="ml-4">- URI: ${uri}</div>`);
                            }
                            break;
                        case 'authorityInfoAccess':
                            try {
                                const ocspOid = forge.pki.oids.ocsp;
                                const caIssuersOid = forge.pki.oids.caIssuers;
                                const aia = forge.asn1.fromDer(ext.value);
                                for (const ad of aia.value) {
                                    const adOid = forge.asn1.derToOid(ad.value[0].value);
                                    if (adOid === ocspOid) {
                                        extDetails += `<div class="ml-4">- OCSP URI: ${ad.value[1].value}</div>`;
                                    } else if (adOid === caIssuersOid) {
                                        extDetails += `<div class="ml-4">- CA Issuers URI: ${ad.value[1].value}</div>`;
                                    }
                                }
                            } catch (e) { /* ignore parsing errors */ }
                            break;
                        case 'certificatePolicies':
                            extDetails += getCertificatePolicies(ext);
                            break;
                        case 'subjectAltName':
                            ext.altNames.forEach(alt => {
                                let label = 'Other', displayValue = alt.value;
                                if (alt.type === 2) label = 'DNS';
                                else if (alt.type === 7) label = 'IP Address';
                                extDetails += `<div class="ml-4">- ${label}: ${displayValue}</div>`;
                            });
                            break;
                        case 'basicConstraints':
                            extDetails += `<div class="ml-4">- CA: ${ext.cA ? 'Yes' : 'No'}</div>`;
                            break;
                        default:
                            if (ext.id === '1.3.6.1.4.1.311.21.1') {
                                ext.name = 'Microsoft Certificate Services CA Version';
                                try {
                                    // Value is an INTEGER: Low 16 bits = Cert Index, High 16 bits = Key Index
                                    const asn1 = forge.asn1.fromDer(ext.value);
                                    const val = parseInt(forge.util.bytesToHex(asn1.value), 16);
                                    const keyIndex = val >> 16;
                                    const certIndex = val & 0xFFFF;
                                    extDetails = `<div class="ml-4">V${keyIndex}.${certIndex}</div>`;
                                } catch (e) {
                                    extDetails = `<div class="ml-4 text-xs opacity-60">(Raw Value)</div>`;
                                }
                            } else {
                                extDetails = `<div class="ml-4 text-xs opacity-60">(OID: ${ext.id})</div>`;
                            }
                    }
                    if (extDetails) {
                        const criticalBadge = ext.critical ? '<span class="ml-2 text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-wider border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20 px-1.5 py-0.5 rounded">Critical</span>' : '';
                        extensionsContent += `<div class="mb-2"><div>${ext.name || ext.id}${criticalBadge}</div>${extDetails}</div>`;
                    }
                });
                if (extensionsContent) html += createSection('Extensions', extensionsContent);

                // Calculate Fingerprints
                const der = forge.asn1.toDer(forge.pki.certificateToAsn1(cert)).getBytes();
                const getFingerprint = (hashFn, bytes) => {
                    const md = hashFn.create();
                    md.update(bytes);
                    return md.digest().toHex();
                };
                const sha1Desc = getFingerprint(forge.md.sha1, der);
                const sha256Desc = getFingerprint(forge.md.sha256, der);

                let thumbprintContent = `<div><span class="font-medium mr-3">SHA-1:</span><span class="break-all opacity-80">${sha1Desc}</span></div>`;
                thumbprintContent += `<div><span class="font-medium mr-3">SHA-256:</span><span class="break-all opacity-80">${sha256Desc}</span></div>`;
                html += createSection('Fingerprints', thumbprintContent);

                html += '</div>';
                output.innerHTML = html;
            } catch (certError) {
                // If input has CERTIFICATE headers, try ASN.1 fallback before CSR
                if (pem.includes('-----BEGIN CERTIFICATE-----')) {
                    try {
                        const ecCert = parseEcCertificateAsn1(pem);
                        renderEcCertificate(ecCert, output);
                        return;
                    } catch (asn1Error) {
                        // ASN.1 fallback also failed - show original error
                        output.innerHTML = `<div class="p-4 text-sm text-red-700 dark:text-red-300 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800"><strong class="font-bold">Parsing Error:</strong> ${certError.message}</div>`;
                        return;
                    }
                }

                // No CERTIFICATE headers - try as CSR (for raw base64 data)
                try {
                    let csrPem = document.getElementById('certInput').value.trim();
                    // Replace literal "\n" characters with actual newlines to support single-line copy-pastes
                    csrPem = csrPem.replace(/\\n/g, '\n');
                    document.getElementById('certInput').value = csrPem;

                    if (!csrPem.includes('-----BEGIN')) {
                        csrPem = csrPem.replace(/[\r\n\s]/g, '');
                        csrPem = csrPem.match(/.{1,64}/g).join('\n');
                        csrPem = '-----BEGIN CERTIFICATE REQUEST-----\n' + csrPem + '\n-----END CERTIFICATE REQUEST-----';
                    }
                    decodeCsr(csrPem);
                } catch (csrError) {
                    output.innerHTML = `<div class="p-4 text-sm text-red-700 dark:text-red-300 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800"><strong class="font-bold">Parsing Error:</strong> ${certError.message}</div>`;
                }
            }
        }

        // Render EC certificate parsed via ASN.1 fallback
        function renderEcCertificate(cert, output) {
            // Uses global helper functions: createSection, sortAttributes
            let html = '<div class="bg-slate-50 dark:bg-black rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">';

            // Subject
            let subjectContent = sortAttributes(cert.subject).map(attr =>
                `<div>${attr.shortName} = <span class="break-all">${attr.value}</span></div>`
            ).join('');
            html += createSection('Subject', subjectContent);

            // Issuer
            let issuerContent = sortAttributes(cert.issuer).map(attr =>
                `<div>${attr.shortName} = <span class="break-all">${attr.value}</span></div>`
            ).join('');
            html += createSection('Issuer', issuerContent);

            // Serial Number
            html += createSection('Serial Number', `<div>${cert.serialNumber}</div>`);

            // Validity
            const isExpired = cert.validity.notAfter && new Date() > cert.validity.notAfter;
            const validityDateClass = isExpired ? 'text-red-600 dark:text-red-400 font-bold' : '';
            let validityContent = `<div>Valid From: ${cert.validity.notBefore ? cert.validity.notBefore.toUTCString() : 'N/A'}</div>`;
            validityContent += `<div>Valid To: <span class="${validityDateClass}">${cert.validity.notAfter ? cert.validity.notAfter.toUTCString() : 'N/A'}</span></div>`;
            html += createSection('Validity Period', validityContent);

            // Public Key
            let pubKeyContent = cert.publicKey.algorithm;
            if (cert.publicKey.details) {
                pubKeyContent += ` (${cert.publicKey.details})`;
            }
            html += createSection('Public Key Info', `<div>${pubKeyContent}</div>`);

            // Signature Algorithm
            html += createSection('Signature Algorithm', `<div>${cert.signatureAlgorithm}</div>`);

            // Extensions
            if (cert.extensions && cert.extensions.length > 0) {
                let extensionsContent = '';
                cert.extensions.forEach(ext => {
                    let extDetails = '';
                    if (ext.details && ext.details.length > 0) {
                        extDetails = ext.details.map(d => `<div class="ml-4">- ${d}</div>`).join('');
                    } else {
                        extDetails = `<div class="ml-4 text-xs opacity-60">(OID: ${ext.oid})</div>`;
                    }
                    const criticalBadge = ext.critical ? '<span class="ml-2 text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-wider border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20 px-1.5 py-0.5 rounded">Critical</span>' : '';
                    extensionsContent += `<div class="mb-2"><div>${ext.name}${criticalBadge}</div>${extDetails}</div>`;
                });
                html += createSection('Extensions', extensionsContent);
            }

            html += '</div>';
            output.innerHTML = html;
        }


        function decodeCsr(pem) {
            const output = document.getElementById('decoderOutput');
            try {
                const csr = forge.pki.certificationRequestFromPem(pem);
                let html = '<div class="bg-slate-50 dark:bg-black rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">';

                // Uses global helper functions: createSection, sortAttributes
                let subjectContent = sortAttributes(csr.subject.attributes).map(attr => `<div>${attr.shortName || attr.name} = <span class="break-all">${attr.value}</span></div>`).join('');
                html += createSection('Subject', subjectContent);

                const sigAlg = forge.pki.oids[csr.signatureOid] || csr.signatureOid;
                html += createSection('Signature Algorithm', `<div>${sigAlg}</div>`);

                const pubKey = csr.publicKey;
                let pubAlg = 'Unknown';
                if (pubKey.n) {
                    pubAlg = `RSA (${pubKey.n.toString(2).length} bits)`;
                } else if (pubKey.ecparams) {
                    const curveOid = forge.pki.oids[pubKey.ecparams.curve.oid];
                    pubAlg = `ECDSA (${curveOid || 'Unknown Curve'})`;
                }
                html += createSection('Public Key Info', `<div>${pubAlg}</div>`);

                let extensionsContent = '';
                if (csr.attributes) {
                    csr.attributes.forEach(attr => {
                        if (attr.name === 'extensionRequest' && attr.extensions) {
                            attr.extensions.forEach(ext => {
                                let extDetails = '';
                                switch (ext.name) {
                                    case 'subjectAltName':
                                        ext.altNames.forEach(alt => {
                                            let label = 'Other', displayValue = alt.value;
                                            if (alt.type === 2) label = 'DNS';
                                            else if (alt.type === 7) label = 'IP Address';
                                            extDetails += `<div class="ml-4">- ${label}: ${displayValue}</div>`;
                                        });
                                        break;
                                    case 'basicConstraints':
                                        extDetails += `<div class="ml-4">- CA: ${ext.cA ? 'Yes' : 'No'}</div>`;
                                        break;
                                    default:
                                        extDetails = `<div class="ml-4 text-xs opacity-60">(OID: ${ext.id})</div>`;
                                }
                                const criticalBadge = ext.critical ? '<span class="ml-2 text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-wider border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20 px-1.5 py-0.5 rounded">Critical</span>' : '';
                                if (extDetails || criticalBadge) {
                                    extensionsContent += `<div class="mb-2"><div>${ext.name || ext.id}${criticalBadge}</div>${extDetails}</div>`;
                                }
                            });
                        }
                    });
                }
                if (extensionsContent) html += createSection('Requested Extensions', extensionsContent);

                html += '</div>';
                output.innerHTML = html;
            } catch (e) {
                // Check if this is an EC-related error - try ASN.1 fallback
                const isEcError = e.message && (
                    e.message.includes('OID is not RSA') ||
                    e.message.includes('Unknown OID') ||
                    e.message.includes('Cannot read public key') ||
                    e.message.includes('Unsupported OID')
                );

                if (isEcError) {
                    try {
                        const ecCsr = parseEcCsrAsn1(pem);
                        renderEcCsr(ecCsr, output);
                        return;
                    } catch (asn1Error) {
                        // ASN.1 fallback failed, show original error
                    }
                }

                output.innerHTML = `<div class="p-4 text-sm text-red-700 dark:text-red-300 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800"><strong class="font-bold">Error:</strong> ${e.message}</div>`;
            }
        }

        // Render EC CSR parsed via ASN.1 fallback
        function renderEcCsr(csr, output) {
            // Uses global helper functions: createSection, sortAttributes
            let html = '<div class="bg-slate-50 dark:bg-black rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">';

            // Subject
            let subjectContent = sortAttributes(csr.subject).map(attr =>
                `<div>${attr.shortName} = <span class="break-all">${attr.value}</span></div>`
            ).join('');
            html += createSection('Subject', subjectContent);

            // Signature Algorithm
            html += createSection('Signature Algorithm', `<div>${csr.signatureAlgorithm}</div>`);

            // Public Key
            let pubKeyContent = csr.publicKey.algorithm;
            if (csr.publicKey.details) {
                pubKeyContent += ` (${csr.publicKey.details})`;
            }
            html += createSection('Public Key Info', `<div>${pubKeyContent}</div>`);

            // Extensions
            if (csr.extensions && csr.extensions.length > 0) {
                let extensionsContent = '';
                csr.extensions.forEach(ext => {
                    let extDetails = '';
                    if (ext.details && ext.details.length > 0) {
                        extDetails = ext.details.map(d => `<div class="ml-4">- ${d}</div>`).join('');
                    } else {
                        extDetails = `<div class="ml-4 text-xs opacity-60">(OID: ${ext.oid})</div>`;
                    }
                    const criticalBadge = ext.critical ? '<span class="ml-2 text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-wider border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20 px-1.5 py-0.5 rounded">Critical</span>' : '';
                    extensionsContent += `<div class="mb-2"><div>${ext.name}${criticalBadge}</div>${extDetails}</div>`;
                });
                html += createSection('Requested Extensions', extensionsContent);
            }

            html += '</div>';
            output.innerHTML = html;
        }


        // ============================================================================
        // KEY DECRYPTION (Tab 3)
        // ============================================================================

        /**
         * Sets up Enter key handler for password field.
         */
        function setupRemovePasswordEnterKey() {
            const passphraseInput = document.getElementById('passphrase');
            const removeButton = document.getElementById('remove-password-button');

            if (passphraseInput && removeButton) {
                passphraseInput.addEventListener('keydown', function (event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        removeButton.click();
                    }
                });
            }
        }

        /**
         * Decrypts an encrypted private key (PKCS#8, RSA, or EC format).
         * Supports AES, 3DES, and DES encryption algorithms.
         */
        function removePassword() {
            const textAreaInput = document.getElementById('pemText').value.trim();
            const passphrase = document.getElementById('passphrase').value;
            const output = document.getElementById('removerOutput');
            const outputSection = document.getElementById('decryptedOutputSection');

            output.textContent = '';
            outputSection.classList.add('hidden');

            if (!textAreaInput) {
                alert('Please provide a PEM key.');
                return;
            }
            if (!passphrase) {
                alert('Please enter a password.');
                return;
            }

            try {
                let unencryptedPem = null;

                if (textAreaInput.includes('ENCRYPTED PRIVATE KEY')) {
                    // PKCS#8 encrypted format - supports RSA, ECC, and other key types
                    const encryptedObj = forge.pki.encryptedPrivateKeyFromPem(textAreaInput);
                    const decryptedAsn1 = forge.pki.decryptPrivateKeyInfo(encryptedObj, passphrase);
                    if (!decryptedAsn1) throw new Error('Decryption failed. Check password or key format.');

                    // Convert decrypted ASN.1 to DER then to PEM (works for all key types including ECC)
                    const der = forge.asn1.toDer(decryptedAsn1).getBytes();
                    const base64 = forge.util.encode64(der);

                    // Format as PKCS#8 unencrypted PEM (works for RSA, ECC, etc.)
                    const lines = base64.match(/.{1,64}/g) || [];
                    unencryptedPem = '-----BEGIN PRIVATE KEY-----\n' + lines.join('\n') + '\n-----END PRIVATE KEY-----';

                } else if (textAreaInput.includes('RSA PRIVATE KEY')) {
                    // Traditional RSA encrypted format
                    const privateKey = forge.pki.decryptRsaPrivateKey(textAreaInput, passphrase);
                    if (!privateKey) throw new Error('Invalid RSA password or corrupted key.');
                    unencryptedPem = forge.pki.privateKeyToPem(privateKey);

                } else if (textAreaInput.includes('EC PRIVATE KEY')) {
                    // Traditional OpenSSL encrypted EC key format
                    const lines = textAreaInput.split(/\r?\n/);
                    let dekInfo = null;
                    let base64Start = 0;

                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].startsWith('DEK-Info:')) {
                            dekInfo = lines[i].substring(9).trim();
                        }
                        if (lines[i] === '' && dekInfo) {
                            base64Start = i + 1;
                            break;
                        }
                    }

                    if (!dekInfo) {
                        throw new Error('This EC key does not appear to be encrypted.');
                    }

                    // Parse DEK-Info (format: "algorithm,IV")
                    const dekParts = dekInfo.split(',');
                    const algorithm = dekParts[0];
                    const iv = forge.util.hexToBytes(dekParts[1]);

                    // Extract base64 body
                    let base64Body = '';
                    for (let i = base64Start; i < lines.length; i++) {
                        if (lines[i].startsWith('-----END')) break;
                        base64Body += lines[i];
                    }
                    const encryptedBytes = forge.util.decode64(base64Body);

                    // Derive key from passphrase using OpenSSL EVP_BytesToKey
                    const keyIv = forge.pbe.opensslDeriveBytes(passphrase, iv.substring(0, 8),
                        algorithm.includes('256') ? 32 : (algorithm.includes('192') ? 24 : 16));

                    // Decrypt
                    let cipher;
                    if (algorithm.includes('AES')) {
                        cipher = forge.cipher.createDecipher('AES-CBC', keyIv);
                    } else if (algorithm.includes('DES-EDE3') || algorithm.includes('DES3')) {
                        cipher = forge.cipher.createDecipher('3DES-CBC', keyIv);
                    } else if (algorithm.includes('DES')) {
                        cipher = forge.cipher.createDecipher('DES-CBC', keyIv.substring(0, 8));
                    } else {
                        throw new Error('Unsupported encryption algorithm: ' + algorithm);
                    }

                    cipher.start({ iv: iv });
                    cipher.update(forge.util.createBuffer(encryptedBytes));
                    const success = cipher.finish();

                    if (!success) throw new Error('Decryption failed. Check password.');

                    const decryptedBytes = cipher.output.getBytes();
                    const base64Out = forge.util.encode64(decryptedBytes);
                    const outLines = base64Out.match(/.{1,64}/g) || [];
                    unencryptedPem = '-----BEGIN EC PRIVATE KEY-----\n' + outLines.join('\n') + '\n-----END EC PRIVATE KEY-----';

                } else {
                    throw new Error('Unsupported or unencrypted key format provided.');
                }

                if (!unencryptedPem) throw new Error('Could not parse or decrypt the private key.');

                output.textContent = unencryptedPem;
                outputSection.classList.remove('hidden');

                const blob = new Blob([unencryptedPem], { type: 'application/x-pem-file' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'unencrypted_key.pem';
                link.className = "inline-flex items-center px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-md shadow-sm transition-colors";
                link.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> Download Decrypted Key`;

                const downloadContainer = document.getElementById('removerDownloadContainer');
                downloadContainer.innerHTML = '';
                downloadContainer.appendChild(link);

            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            setupCertificateChainVerifier();
            setupRemovePasswordEnterKey();

            // Tab init
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('hostname')) {
                const hostname = urlParams.get('hostname');
                const port = urlParams.get('port');
                switchTab('cert_chain');
                document.getElementById('hostname-input').value = hostname;
                if (port) document.getElementById('port-input').value = port;

                // Auto-submit if hostname present
                const verifyForm = document.getElementById('verify-form');
                if (verifyForm) {
                    const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                    verifyForm.dispatchEvent(submitEvent);
                }
            }
        });
    </script>
</body>

</html>